var e=Object.defineProperty;import{i as t,j as r,b as s,P as o,d as a,e as i,G as n,t as l,S as d,v as c,w as h,n as x,o as p,C as u,x as m,p as g,y as b}from"./mui-4H20ALa5.js";import{c as f,r as j}from"./vendor-0_jEQBB2.js";import{P as v}from"./PDFPreview-DZpJ47x7.js";import{r as w}from"./index-CgZOgMeD.js";import{u as y}from"./router-Csy8SDXT.js";import"./mui-deps-DlUk4hWl.js";import"./Close-xbK16gS_.js";var k={},S=t;Object.defineProperty(k,"__esModule",{value:!0});var C=k.default=void 0,E=S(w()),I=r;C=k.default=(0,E.default)((0,I.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"}),"Refresh");class A extends f.Component{constructor(t){var r;super(t),((t,r,s)=>{r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s})(this,"symbol"!=typeof(r="handleReset")?r+"":r,(()=>{this.setState({hasError:!1,error:null,errorInfo:null})})),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){this.setState({errorInfo:t})}render(){return this.state.hasError?r.jsx(s,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"200px",p:3},children:r.jsxs(o,{elevation:3,sx:{p:4,maxWidth:"600px",width:"100%",textAlign:"center"},children:[r.jsx(s,{component:"h2",sx:{fontSize:"1.5rem",fontWeight:500,mb:2,color:"error.main"},children:"Something went wrong"}),r.jsx(a,{variant:"body1",color:"text.secondary",sx:{mb:3},children:this.props.fallbackMessage||"An error occurred while rendering this component."}),!1,r.jsx(i,{variant:"contained",startIcon:r.jsx(C,{}),onClick:this.handleReset,sx:{mt:2},children:"Try Again"})]})}):this.props.children}}const _=({count:e=6})=>r.jsx(n,{container:!0,spacing:3,children:[...Array(e)].map(((e,t)=>r.jsx(n,{item:!0,xs:12,sm:6,md:4,children:r.jsxs(l,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[r.jsx(d,{variant:"rectangular",height:200,animation:"wave",sx:{m:1}}),r.jsxs(c,{sx:{flexGrow:1},children:[r.jsx(d,{variant:"text",height:32,width:"80%",sx:{mb:1}}),r.jsx(d,{variant:"text",height:24,width:"60%",sx:{mb:2}}),r.jsx(d,{variant:"rounded",height:24,width:"40%",sx:{mb:1}}),r.jsx(s,{sx:{mb:2},children:r.jsx(d,{variant:"rounded",height:32,width:"100%"})}),r.jsxs(s,{sx:{display:"flex",gap:1},children:[r.jsx(d,{variant:"rounded",height:32,width:"30%"}),r.jsx(d,{variant:"rounded",height:32,width:"30%"}),r.jsx(d,{variant:"rounded",height:32,width:"30%"})]})]}),r.jsxs(h,{sx:{p:2,justifyContent:"space-between"},children:[r.jsx(d,{variant:"rounded",width:100,height:36}),r.jsx(d,{variant:"rounded",width:100,height:36})]})]})},`skeleton-${t}`)))}),D=({books:e,onReadBook:t,onPreviewBook:o,theme:i})=>{const d=p(i.breakpoints.down("sm"));return r.jsx(s,{sx:{width:"100%",pb:2,overflowX:d?"auto":"hidden",WebkitOverflowScrolling:"touch","& .MuiGrid-container":{width:d?"auto":"100%",flexWrap:d?"nowrap":"wrap",px:d?2:0}},children:r.jsx(n,{container:!0,spacing:2,children:e.map(((e,o)=>r.jsx(n,{item:!0,xs:8,sm:6,md:4,lg:3,sx:{flexShrink:0,width:d?"calc(150% - 16px)":"auto"},children:r.jsx(l,{sx:{height:"100%",position:"relative",cursor:"completed"===(null==e?void 0:e.status)?"pointer":"default",transition:"transform 0.2s, box-shadow 0.2s","&:hover":{transform:"completed"===(null==e?void 0:e.status)?"translateY(-4px)":"none",boxShadow:"completed"===(null==e?void 0:e.status)?6:1}},onClick:()=>"completed"===(null==e?void 0:e.status)&&t(e),children:r.jsxs(s,{sx:{position:"relative",pt:"140%"},children:[r.jsx(b,{component:"img",image:`/api/books/${e.id}/cover`,alt:`Couverture de ${e.title}`,sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover"}}),r.jsx(s,{sx:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%)",p:2,color:"white"},children:r.jsx(a,{variant:"h6",sx:{fontWeight:500,textShadow:"1px 1px 2px rgba(0,0,0,0.5)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:(null==e?void 0:e.title)||"Sans titre"})})]})})},`book-${(null==e?void 0:e.id)||o}`)))})})},P=()=>{const[e,t]=j.useState([]),[o,n]=j.useState(!0);j.useState(!1);const[l,d]=j.useState(null),[c,h]=j.useState(""),[b,f]=j.useState(!1),[w,k]=j.useState(null),S=x(),C=p(S.breakpoints.down("sm")),E=y();j.useEffect((()=>{I();const e=setInterval(I,5e3);return()=>clearInterval(e)}),[]);const I=async()=>{try{d(null),n(!0);const r=await fetch("/api/books");if(404===r.status)return void t([]);if(!r.ok)throw await r.text(),r.status,new Error(`Impossible de charger la bibliothèque (${r.status})`);let s;try{s=await r.json()}catch(e){throw new Error("Format de réponse invalide")}if(!s||"object"!=typeof s)throw new Error("Structure de données invalide");const o=(Array.isArray(s.books)?s.books:[]).map(((e={})=>e.id||e.filename?{id:e.id||e.filename,title:e.title||"Sans titre",author:e.author||"Auteur inconnu",filename:e.filename||"",uploadDate:e.uploadDate||(new Date).toISOString(),status:e.status||"pending",current_page:parseInt(e.current_page,10)||0,total_pages:parseInt(e.total_pages,10)||0,processed_sections:parseInt(e.processed_sections,10)||0,processed_images:parseInt(e.processed_images,10)||0,error_message:e.error_message||null,...e}:null)).filter(Boolean);t(o)}catch(r){r instanceof TypeError||SyntaxError,d(r.message),t([])}finally{n(!1)}};return r.jsxs(u,{maxWidth:"lg",sx:{py:4},children:[r.jsxs(s,{sx:{mb:4,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:2,p:2,borderRadius:2,bgcolor:"background.paper"},children:[r.jsx(s,{children:r.jsx(a,{variant:C?"h5":"h4",sx:{fontWeight:500,color:"primary.main",mb:2},children:"Bibliothèque"})}),r.jsx(s,{sx:{display:"flex",gap:2,flexWrap:"wrap"}})]}),r.jsx(m,{open:!!c,autoHideDuration:6e3,onClose:()=>h(""),message:c}),l&&r.jsx(g,{severity:"error",sx:{mb:3},onClose:()=>d(null),action:r.jsx(i,{color:"inherit",size:"small",onClick:I,children:"Retry"}),children:l}),o?r.jsx(A,{fallbackMessage:"Error displaying skeleton loader",children:r.jsx(_,{count:6})}):r.jsxs(r.Fragment,{children:[Array.isArray(e)&&0===e.length&&r.jsxs(s,{sx:{textAlign:"center",mt:4,p:4,backgroundColor:"background.paper",borderRadius:2,border:1,borderColor:"divider"},children:[r.jsx(a,{variant:"h6",color:"text.secondary",children:"No books in library"}),r.jsx(a,{variant:"body1",color:"text.secondary",sx:{mt:1},children:"Start by uploading a PDF"})]}),Array.isArray(e)&&e.length>0&&r.jsx(A,{fallbackMessage:"Error displaying book grid",children:r.jsx(D,{books:e,onReadBook:e=>{"completed"===(null==e?void 0:e.status)?E(`/books/${e.id}`):d("This book is not ready for reading yet")},onPreviewBook:e=>{"completed"===(null==e?void 0:e.status)?(k(e),f(!0)):d("This book is not ready for preview yet")},theme:S})})]}),w&&r.jsx(A,{fallbackMessage:"Error displaying PDF preview",children:r.jsx(v,{open:b,onClose:()=>{f(!1),k(null)},pdfUrl:`/api/books/${w.filename}`,bookTitle:w.title})})]})};export{P as default};
